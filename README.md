# 小程序框架性能大比拼

<!-- prettier-ignore -->
> [!NOTE]
> 此 benchmark fork 至 [hiyuki/mp-framework-benchmark](https://github.com/hiyuki/mp-framework-benchmark)，原作者为董宏平（hiyuki），本文中的第一人称也指原作者。在此表示感谢。

> 本文的所有数据均使用 iPhone XR 测得（iOS v17.5.1，微信 v8.0.49），测试全程手机电量维持 100%，并连接着充电器。每项测试跑三次取平均数。

在本文中，我们将对小程序原生框架、[Vue Mini](https://vuemini.org) (v1.0.0-rc.11) 以及 [Taro](https://taro.zone) (v3.6.32) 进行性能测试，测试内容包括以下几个维度：

- 页面渲染耗时
- 页面更新耗时
- 局部更新耗时

测试代码存放于以下仓库中：

- https://github.com/yangmingshan/native-benchmark
- https://github.com/yangmingshan/vue-mini-benchmark
- https://github.com/yangmingshan/taro-benchmark

## 测试方案

为了使测试结果真实有效，我基于常见的业务场景构建了两种测试场景，分别是动态测试场景和静态测试场景。

### 动态测试场景

动态测试中，视图基于数据动态渲染，静态节点较少，视图更新耗时是该测试场景中的主要测试点。

动态测试 Demo 模拟了实际业务中常见的长列表 + 多 Tab 场景，该 Demo 中存在两份优惠券列表数据，一份为可用券数据，另一份为不可用券数据，其中同一时刻视图中只会渲染展示其中一份数据，可以在上方的操作区模拟对列表数据的各种操作及视图展示切换(切换 Tab)。

在动态测试中，我在外部通过函数代理的方式在初始化之前将 App、Page 和 Component 构造器进行代理，通过 mixin 的方式在 Page 的 onLoad 和 Component 的 created 钩子中注入 setData 拦截逻辑，对所有页面和组件的 setData 调用进行监听，并统计小程序的视图更新耗时。该测试方式能够做到对框架代码的零侵入，能够跟踪到小程序全量的 setData 行为并进行独立的耗时计算，具有很强的普适性，代码具体实现可以查看：https://github.com/hiyuki/mp-framework-benchmark/blob/master/utils/proxy.js

### 静态测试场景

静态测试模拟业务中静态页面的场景，如运营活动和文章等页面，页面内具备大量的静态节点，而没有数据动态渲染，初始 ready 耗时是该场景下测试的重心。

静态测试 Demo 使用了我去年发表的一篇技术文章的 html 代码进行小程序适配构建，其中包含大量静态节点及文本内容。

## 测试流程及数据

### 动态测试

#### 页面更新耗时（无后台数据）

这里后台数据的定义为 data 中存在但当前页面渲染中未使用到的数据，在这个 Demo 场景下即为不可用券的数据，当前会在不可用券为 0 的情况下，对可用券列表进行各种操作，并统计更新耗时。

更新耗时的计算方式是从数据操作事件触发开始到对应的 setData 回调完成的耗时。

> 理论上来讲 Native 的性能在进行优化的前提下一定是所有框架的天花板，但是在日常业务开发中我们可能无法对每一次 setData 都进行优化，以下性能测试中所有的 Native 数据均采用修改数据后全量发送的形式来实现。

第一项测试我们使用 `新增可用券（100）` 操作将可用券数量由 0 逐级递增到 1000：

|          | 100   | 200   | 300   | 400   | 500    | 600    | 700    | 800    | 900   | 1000  |
| -------- | ----- | ----- | ----- | ----- | ------ | ------ | ------ | ------ | ----- | ----- |
| Native   | 82.7  | 68.3  | 72    | 78.7  | 84.7   | 93.3   | 93.7   | 101.3  | 109.3 | 113.3 |
| Vue Mini | 101   | 100.3 | 104.7 | 114.7 | 130    | 129.7  | 146.3  | 157    | 169.7 | 179.7 |
| Taro     | 450.3 | 629.7 | 827.7 | 1021  | 1227.3 | 1446.3 | 1676.3 | 1867.7 | 2058  | 2266  |

然后我们按顺序逐项点击 `删除可用券（all）` -> `新增可用券（1000）` -> `更新可用券（1）` -> `更新可用券（all）` -> `删除可用券（1）`：

|          | Delete (All) | Add (1000) | Update (1) | Update (All) | Delete (1) |
| -------- | ------------ | ---------- | ---------- | ------------ | ---------- |
| Native   | 55.7         | 430        | 82.7       | 86           | 80         |
| Vue Mini | 66.3         | 587        | 147.3      | 134.3        | 146.3      |
| Taro     | 137.7        | 3997.3     | 2057.3     | 2491.7       | 2551.7     |
